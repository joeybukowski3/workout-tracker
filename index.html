<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Workout Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const DAY_KEYS = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const STORAGE_KEY = 'workoutAppState';
    const APP_VERSION = 1;

    const DAILY_STRETCHES = [
      '90/90 Hip Switch',
      'Thread the Needle',
      "World's Greatest Stretch (with T-Spine Rotation)",
      'Terminal Knee Extensions (TKEs) - Standing'
    ];

    // Lucide React icons as SVG components
    const Calendar = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const TrendingUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const Dumbbell = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="m6.5 6.5 11 11"></path>
        <path d="m21 21-1-1"></path>
        <path d="m3 3 1 1"></path>
        <path d="m18 22 4-4"></path>
        <path d="m2 6 4-4"></path>
        <path d="m3 10 7-7"></path>
        <path d="m14 21 7-7"></path>
      </svg>
    );

    const Menu = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    );

    const Download = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const ChevronDown = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const ChevronUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    );

    const ArrowUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    );

    const parseCsv = (text) => {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (lines.length === 0) return [];
      const headers = parseCsvLine(lines[0]);
      return lines.slice(1).map(line => {
        const values = parseCsvLine(line);
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx] ?? '';
        });
        return row;
      });
    };

    const parseCsvLine = (line) => {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"' && line[i + 1] === '"') {
          current += '"';
          i += 1;
          continue;
        }
        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
          continue;
        }
        current += char;
      }
      result.push(current);
      return result.map(value => value.trim());
    };

    const toLocalDateString = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };

    const parseLocalDate = (value) => {
      const [year, month, day] = value.split('-').map(Number);
      return new Date(year, month - 1, day);
    };

    const diffInDays = (start, end) => {
      const startAtNoon = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 12, 0, 0);
      const endAtNoon = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12, 0, 0);
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.floor((endAtNoon - startAtNoon) / msPerDay);
    };

    const slugify = (value) => value
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');

    const getExerciseEmoji = (name) => {
      const lower = name.toLowerCase();
      if (lower.includes('walk') || lower.includes('bike')) return '🏃';
      if (lower.includes('bench') || lower.includes('press') && lower.includes('chest')) return '🏋️';
      if (lower.includes('deadlift') || lower.includes('squat')) return '💪';
      if (lower.includes('curl')) return '💪';
      if (lower.includes('row') || lower.includes('pull')) return '🚣';
      if (lower.includes('leg') || lower.includes('calf')) return '🦵';
      if (lower.includes('shoulder') || lower.includes('delt')) return '💪';
      if (lower.includes('tricep')) return '💪';
      if (lower.includes('stretch') || lower.includes('mobility')) return '🧘';
      if (lower.includes('foam') || lower.includes('roll')) return '🧘';
      return '💪';
    };

    function WorkoutTracker() {
      const [tab, setTab] = useState('today');
      const [programs, setPrograms] = useState([]);
      const [programManifest, setProgramManifest] = useState(null);
      const [programBasePath, setProgramBasePath] = useState('');
      const [programDayCache, setProgramDayCache] = useState({});
      const [programLoadError, setProgramLoadError] = useState('');
      const [programFileWarnings, setProgramFileWarnings] = useState([]);

      const [activeProgramId, setActiveProgramId] = useState('program-1');
      const [programStartDate, setProgramStartDate] = useState('');
      const [currentWeek, setCurrentWeek] = useState(1);
      const [completedDays, setCompletedDays] = useState({});
      const [lastOpenedDate, setLastOpenedDate] = useState('');

      const [workoutLogs, setWorkoutLogs] = useState([]);
      const [bodyweightLogs, setBodyweightLogs] = useState([]);
      const [history, setHistory] = useState([]);
      const [todayWeight, setTodayWeight] = useState('');
      const [todayInputs, setTodayInputs] = useState({});
      const [expandedExercises, setExpandedExercises] = useState({});
      const [expandedHistory, setExpandedHistory] = useState({});
      const [showMenu, setShowMenu] = useState(false);
      const [showStretches, setShowStretches] = useState(false);
      const [viewWeek, setViewWeek] = useState(1);
      const fileInputRef = useRef(null);

      const today = new Date();
      const todayStr = toLocalDateString(today);
      const todayDayKey = DAY_KEYS[today.getDay()];
      const todayDayName = DAYS[today.getDay()];

      useEffect(() => {
        const loadPrograms = async () => {
          try {
            const response = await fetch('data/programs/index.json');
            if (!response.ok) throw new Error('Program index not found');
            const data = await response.json();
            setPrograms(data.programs || []);
          } catch (error) {
            console.error(error);
            setPrograms([{ id: 'program-1', name: 'Program 1', path: 'data/programs/program-1/program.json' }]);
            setProgramLoadError('Unable to load program library. Using default program.');
          }
        };
        loadPrograms();
      }, []);

      useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.version === APP_VERSION) {
            setActiveProgramId(data.activeProgramId || 'program-1');
            setProgramStartDate(data.programStartDate || todayStr);
            setCurrentWeek(data.currentWeek || 1);
            setCompletedDays(data.completedDays || {});
            setLastOpenedDate(data.lastOpenedDate || todayStr);
            setWorkoutLogs(data.workoutLogs || []);
            setBodyweightLogs(data.bodyweightLogs || []);
            setHistory(data.history || []);
            setViewWeek(data.currentWeek || 1);
            return;
          }
        }

        const legacyV2 = localStorage.getItem('workoutTrackerDataV2');
        if (legacyV2) {
          try {
            const data = JSON.parse(legacyV2);
            setActiveProgramId(data.activeProgramId || 'program-1');
            setProgramStartDate(data.startDate || todayStr);
            setCurrentWeek(data.activeWeek || 1);
            setCompletedDays({});
            setLastOpenedDate(todayStr);
            setWorkoutLogs(data.workoutLogs || []);
            setBodyweightLogs(data.bodyweightLogs || []);
            setHistory(data.history || []);
            setViewWeek(data.activeWeek || 1);
            return;
          } catch (error) {
            console.error('Failed to migrate V2 data', error);
          }
        }

        const legacy = localStorage.getItem('workoutData');
        if (legacy) {
          try {
            const data = JSON.parse(legacy);
            setActiveProgramId('program-1');
            setProgramStartDate(todayStr);
            setCurrentWeek(data.currentWeek || 1);
            setCompletedDays({});
            setLastOpenedDate(todayStr);
            setWorkoutLogs(data.workoutLogs || []);
            setBodyweightLogs(data.bodyweightLogs || []);
            setHistory([]);
            setViewWeek(data.currentWeek || 1);
            return;
          } catch (error) {
            console.error('Failed to migrate legacy data', error);
          }
        }

        setProgramStartDate(todayStr);
        setLastOpenedDate(todayStr);
      }, [todayStr]);

      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          version: APP_VERSION,
          activeProgramId,
          programStartDate,
          currentWeek,
          completedDays,
          lastOpenedDate,
          workoutLogs,
          bodyweightLogs,
          history
        }));
      }, [
        activeProgramId,
        programStartDate,
        currentWeek,
        completedDays,
        lastOpenedDate,
        workoutLogs,
        bodyweightLogs,
        history
      ]);

      useEffect(() => {
        if (!programStartDate) return;
        setLastOpenedDate(todayStr);

        const startDate = parseLocalDate(programStartDate);
        const daysSinceStart = diffInDays(startDate, today);
        if (daysSinceStart < 0) {
          setCurrentWeek(1);
          setViewWeek(1);
          return;
        }

        const durationWeeks = programManifest?.durationWeeks || 6;
        const calculatedWeek = Math.min(durationWeeks, Math.floor(daysSinceStart / 7) + 1);
        setCurrentWeek(calculatedWeek);
        setViewWeek(calculatedWeek);
      }, [programStartDate, todayStr, programManifest]);

      useEffect(() => {
        if (!activeProgramId || programs.length === 0) return;
        const selected = programs.find(program => program.id === activeProgramId) || programs[0];
        if (!selected) return;

        const loadProgram = async () => {
          try {
            const response = await fetch(selected.path);
            if (!response.ok) throw new Error('Program manifest not found');
            const manifest = await response.json();
            setProgramManifest(manifest);
            const basePath = selected.path.split('/').slice(0, -1).join('/');
            setProgramBasePath(basePath);
            setProgramDayCache({});
            setProgramFileWarnings([]);
          } catch (error) {
            console.error(error);
            setProgramManifest(null);
            setProgramLoadError(`Unable to load program manifest for ${selected.name}.`);
          }
        };

        loadProgram();
      }, [activeProgramId, programs]);

      useEffect(() => {
        if (!programManifest) return;
        ensureDayLoaded(todayDayKey);
      }, [programManifest, todayDayKey]);

      useEffect(() => {
        const exercises = programDayCache[todayDayKey] || [];
        const defaults = {};
        exercises.forEach(ex => {
          if (!todayInputs[ex]) {
            defaults[ex] = { weight: '', reps: '10' };
          }
        });
        if (Object.keys(defaults).length > 0) {
          setTodayInputs(prev => ({ ...prev, ...defaults }));
        }
      }, [programDayCache, todayDayKey]);

      const getCompletedForProgram = () => completedDays?.[activeProgramId] || {};

      const ensureDayLoaded = async (dayKey) => {
        if (!programManifest || !programBasePath) return;
        if (programDayCache[dayKey]) return;

        const fileName = programManifest.fileMap?.[dayKey];
        if (!fileName) {
          setProgramFileWarnings(prev => [...new Set([...prev, `Missing file map for ${dayKey}`])]);
          setProgramDayCache(prev => ({ ...prev, [dayKey]: [] }));
          return;
        }

        const filePath = `${programBasePath}/${fileName}`;
        try {
          const response = await fetch(filePath);
          if (!response.ok) throw new Error('Missing file');
          const text = await response.text();
          const rows = parseCsv(text);
          const exercises = rows.map(row => row.Exercise).filter(Boolean);
          setProgramDayCache(prev => ({ ...prev, [dayKey]: exercises }));
        } catch (error) {
          console.error(error);
          setProgramFileWarnings(prev => [...new Set([...prev, `Missing program file: ${fileName}`])]);
          setProgramDayCache(prev => ({ ...prev, [dayKey]: [] }));
        }
      };

      const isCardioExercise = (exerciseName) => {
        const lower = exerciseName.toLowerCase();
        return lower.includes('walk') || lower.includes('bike') || lower.includes('run');
      };

      const getLastWorkout = (exerciseId) => {
        const logs = workoutLogs.filter(log => log.programId === activeProgramId && log.exerciseId === exerciseId);
        return logs.length > 0 ? logs[logs.length - 1] : null;
      };

      const getAllWorkouts = (exerciseId) => {
        return workoutLogs
          .filter(log => log.programId === activeProgramId && log.exerciseId === exerciseId)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
      };

      const calculateGain = (exerciseId) => {
        const logs = getAllWorkouts(exerciseId).slice().reverse();
        if (logs.length < 2) return null;
        const first = logs[0];
        const last = logs[logs.length - 1];
        const firstVol = first.weight * first.reps;
        const lastVol = last.weight * last.reps;
        const gain = ((lastVol - firstVol) / firstVol * 100).toFixed(1);
        return { first, last, gain: parseFloat(gain) };
      };

      const logWorkout = () => {
        const exercises = programDayCache[todayDayKey] || [];
        const logs = exercises.map(exName => {
          const isCardio = isCardioExercise(exName);
          return {
            exerciseId: slugify(exName),
            exerciseName: exName,
            weight: parseFloat(todayInputs[exName]?.weight || 0),
            reps: isCardio ? parseFloat(todayInputs[exName]?.reps || 0) : parseInt(todayInputs[exName]?.reps || 0),
            date: todayStr,
            week: currentWeek,
            dayOfWeek: todayDayKey,
            isCardio,
            programId: activeProgramId
          };
        }).filter(log => log.weight > 0 && log.reps > 0);

        const currentCompleted = getCompletedForProgram();
        const updatedCompleted = { ...currentCompleted, [todayStr]: true };
        setCompletedDays(prev => ({
          ...prev,
          [activeProgramId]: updatedCompleted
        }));

        if (logs.length > 0) {
          setWorkoutLogs(prev => [...prev, ...logs]);
          setTodayInputs({});
          alert('Workout logged.');
        } else {
          alert('Day marked complete.');
        }

        checkProgramCompletion(updatedCompleted);
      };

      const logBodyweight = () => {
        if (todayWeight && parseFloat(todayWeight) > 0) {
          setBodyweightLogs(prev => [...prev, { weight: parseFloat(todayWeight), date: todayStr }]);
          setTodayWeight('');
          alert('Bodyweight logged.');
        }
      };

      const checkProgramCompletion = (completedOverride) => {
        if (!programStartDate) return;
        const durationWeeks = programManifest?.durationWeeks || 6;
        const totalDays = durationWeeks * 7;
        const startDate = parseLocalDate(programStartDate);
        const completed = completedOverride || getCompletedForProgram();

        let completedCount = 0;
        let allComplete = true;
        for (let i = 0; i < totalDays; i += 1) {
          const date = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i);
          const dateStr = toLocalDateString(date);
          if (completed[dateStr]) {
            completedCount += 1;
          } else {
            allComplete = false;
          }
        }

        if (!allComplete) return;

        const existing = history.some(item => item.programId === activeProgramId && item.startDate === programStartDate);
        if (existing) return;

        const endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + totalDays - 1);
        const summary = {
          id: `${activeProgramId}-${programStartDate}`,
          programId: activeProgramId,
          programName: programManifest?.name || activeProgramId,
          startDate: programStartDate,
          endDate: toLocalDateString(endDate),
          completedDays: completedCount,
          totalDays,
          completionRate: Math.round((completedCount / totalDays) * 100)
        };

        setHistory(prev => [summary, ...prev]);
      };

      const getMissedDays = () => {
        if (!programStartDate) return [];
        const startDate = parseLocalDate(programStartDate);
        const daysSinceStart = diffInDays(startDate, today);
        if (daysSinceStart <= 0) return [];

        const completed = getCompletedForProgram();
        const missed = [];
        for (let i = 0; i < daysSinceStart; i += 1) {
          const date = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i);
          const dateStr = toLocalDateString(date);
          if (!completed[dateStr]) {
            missed.push(dateStr);
          }
        }
        return missed;
      };

      const resumeProgram = () => {
        ensureDayLoaded(todayDayKey);
        setTab('today');
      };

      const restartProgram = () => {
        setProgramStartDate(todayStr);
        setCurrentWeek(1);
        setViewWeek(1);
        setCompletedDays(prev => ({ ...prev, [activeProgramId]: {} }));
      };

      const exportData = () => {
        const data = {
          version: APP_VERSION,
          activeProgramId,
          programStartDate,
          currentWeek,
          completedDays,
          lastOpenedDate,
          workoutLogs,
          bodyweightLogs,
          history,
          exportDate: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout-tracker-backup-${todayStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setShowMenu(false);
        alert('Data exported successfully.');
      };

      const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (confirm('This will replace all current data. Continue?')) {
              setActiveProgramId(data.activeProgramId || 'program-1');
              setProgramStartDate(data.programStartDate || todayStr);
              setCurrentWeek(data.currentWeek || 1);
              setCompletedDays(data.completedDays || {});
              setLastOpenedDate(data.lastOpenedDate || todayStr);
              setWorkoutLogs(data.workoutLogs || []);
              setBodyweightLogs(data.bodyweightLogs || []);
              setHistory(data.history || []);
              setViewWeek(data.currentWeek || 1);
              setShowMenu(false);
              alert('Data imported successfully.');
            }
          } catch (error) {
            alert('Error importing data. Please check the file format.');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const renderToday = () => {
        const exercises = programDayCache[todayDayKey] || [];
        const completed = getCompletedForProgram()[todayStr];
        const missedDays = getMissedDays();

        return (
          <div className="space-y-3">
            <div className="bg-gray-800 p-3 rounded-lg space-y-2">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400">Active Program</p>
                  <p className="text-sm text-white font-semibold">{programManifest?.name || 'Loading...'}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-400">Progress</p>
                  <p className="text-sm text-white">Week {currentWeek} · {todayDayName}</p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={resumeProgram} className="flex-1 px-3 py-2 bg-blue-600 rounded text-white text-xs">
                  Resume
                </button>
                <button onClick={restartProgram} className="flex-1 px-3 py-2 bg-gray-700 rounded text-white text-xs">
                  Restart
                </button>
              </div>
              <div className="flex justify-between text-xs text-gray-400">
                <span>Start: {programStartDate || 'Not set'}</span>
                <span>Last opened: {lastOpenedDate || 'None'}</span>
              </div>
              {missedDays.length > 0 && (
                <p className="text-xs text-yellow-400">Missed days: {missedDays.length}</p>
              )}
            </div>

            <div className="bg-gray-800 p-3 rounded-lg">
              <h3 className="text-sm text-gray-400 mb-2">Bodyweight Today</h3>
              <div className="flex gap-2">
                <input
                  type="number"
                  step="0.1"
                  value={todayWeight}
                  onChange={(e) => setTodayWeight(e.target.value)}
                  placeholder="Enter weight (lbs)"
                  className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                />
                <button onClick={logBodyweight} className="px-4 py-2 bg-green-600 rounded text-white text-sm">
                  Log
                </button>
              </div>
            </div>

            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">{todayDayName} - Week {currentWeek}</h2>
              {completed && (
                <span className="text-xs text-green-400">Completed</span>
              )}
            </div>

            {exercises.length === 0 ? (
              <div className="text-center py-12 text-gray-400 space-y-3">
                <p>No workout scheduled for {todayDayName}</p>
                <button
                  onClick={logWorkout}
                  className="px-4 py-2 bg-green-600 rounded text-white text-sm"
                >
                  Mark Day Complete
                </button>
              </div>
            ) : (
              <>
                {exercises.map((exName, idx) => {
                  const exerciseId = slugify(exName);
                  const last = getLastWorkout(exerciseId);
                  const isCardio = isCardioExercise(exName);

                  return (
                    <div key={idx} className="bg-gray-800 p-3 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xl">{getExerciseEmoji(exName)}</span>
                        <div className="flex-1">
                          <h3 className="text-white font-medium text-sm">{exName}</h3>
                          {last && (
                            <p className="text-xs text-gray-400">
                              Last: {last.weight}{isCardio ? '°' : 'lbs'} × {last.reps} {isCardio ? 'mi' : 'reps'}
                            </p>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <input
                          type="number"
                          placeholder={isCardio ? "Incline" : "Weight"}
                          value={todayInputs[exName]?.weight || ''}
                          onChange={(e) => setTodayInputs(prev => ({
                            ...prev,
                            [exName]: { ...prev[exName], weight: e.target.value }
                          }))}
                          className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                        />
                        {isCardio ? (
                          <input
                            type="number"
                            step="0.1"
                            placeholder="Distance"
                            value={todayInputs[exName]?.reps || ''}
                            onChange={(e) => setTodayInputs(prev => ({
                              ...prev,
                              [exName]: { ...prev[exName], reps: e.target.value }
                            }))}
                            className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                          />
                        ) : (
                          <select
                            value={todayInputs[exName]?.reps || '10'}
                            onChange={(e) => setTodayInputs(prev => ({
                              ...prev,
                              [exName]: { ...prev[exName], reps: e.target.value }
                            }))}
                            className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                          >
                            {[...Array(40)].map((_, i) => (
                              <option key={i + 1} value={i + 1}>{i + 1}</option>
                            ))}
                          </select>
                        )}
                      </div>
                    </div>
                  );
                })}
                <button
                  onClick={logWorkout}
                  className="w-full py-3 bg-green-600 rounded-lg text-white font-semibold"
                >
                  Complete Workout
                </button>

                <div className="bg-gray-800 rounded-lg overflow-hidden">
                  <button
                    onClick={() => setShowStretches(!showStretches)}
                    className="w-full p-3 flex justify-between items-center"
                  >
                    <h3 className="text-white font-semibold text-sm">Daily Stretches</h3>
                    {showStretches ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}
                  </button>
                  {showStretches && (
                    <div className="px-3 pb-3 space-y-2">
                      {DAILY_STRETCHES.map((stretch, idx) => (
                        <div key={idx} className="flex items-start gap-2">
                          <span className="text-gray-400 text-xs mt-0.5">{idx + 1}.</span>
                          <span className="text-gray-300 text-xs">{stretch}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        );
      };

      const renderSchedule = () => {
        const duration = programManifest?.durationWeeks || 6;

        return (
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">Week {viewWeek} Schedule</h2>
              <div className="flex gap-2">
                {Array.from({ length: duration }, (_, i) => i + 1).map(week => (
                  <button
                    key={week}
                    onClick={() => setViewWeek(week)}
                    className={`px-3 py-1 rounded text-sm ${viewWeek === week ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'}`}
                  >
                    Week {week}
                  </button>
                ))}
              </div>
            </div>

            {DAY_KEYS.map((dayKey, idx) => (
              <div key={dayKey} className="bg-gray-800 p-3 rounded-lg">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-white font-semibold text-sm">{DAYS[idx]}</h3>
                  <button
                    onClick={() => ensureDayLoaded(dayKey)}
                    className="text-xs text-gray-400"
                  >
                    Load
                  </button>
                </div>
                {(programDayCache[dayKey] || []).length === 0 ? (
                  <p className="text-gray-400 text-sm">Rest Day / Not loaded</p>
                ) : (
                  <div className="space-y-1">
                    {(programDayCache[dayKey] || []).map((exName, exIdx) => (
                      <div key={exIdx} className="text-gray-300 text-xs">
                        {getExerciseEmoji(exName)} {exName}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      };

      const renderStrength = () => {
        const exercisesWithData = [...new Set(workoutLogs
          .filter(log => log.programId === activeProgramId)
          .map(log => log.exerciseId))];

        return (
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-white">Strength Progress</h2>
            {exercisesWithData.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No workout data yet. Start logging!</p>
            ) : (
              exercisesWithData.map((exerciseId, idx) => {
                const allLogs = getAllWorkouts(exerciseId);
                const last = allLogs[0];
                const progress = calculateGain(exerciseId);
                const isExpanded = expandedExercises[exerciseId];
                if (!last || !progress) return null;

                const { first, gain } = progress;
                const isCardio = last.isCardio;

                return (
                  <div key={idx} className="bg-gray-800 rounded-lg overflow-hidden">
                    <div className="p-3">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xl">{getExerciseEmoji(last.exerciseName)}</span>
                        <h3 className="text-white font-medium text-sm flex-1">{last.exerciseName}</h3>
                        <button
                          onClick={() => setExpandedExercises(prev => ({ ...prev, [exerciseId]: !prev[exerciseId] }))}
                          className="text-gray-400"
                        >
                          {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-3 text-xs">
                        <div>
                          <p className="text-gray-400 mb-1">Baseline</p>
                          <p className="text-white">{first.weight}{isCardio ? '°' : 'lbs'} × {first.reps} {isCardio ? 'mi' : 'reps'}</p>
                        </div>
                        <div>
                          <p className="text-gray-400 mb-1">Current</p>
                          <p className="text-white">{last.weight}{isCardio ? '°' : 'lbs'} × {last.reps} {isCardio ? 'mi' : 'reps'}</p>
                        </div>
                      </div>
                      <div className={`mt-2 flex items-center gap-2 ${gain > 0 ? 'text-green-400' : gain < 0 ? 'text-red-400' : 'text-gray-400'}`}>
                        {gain > 0 && <ArrowUp size={14} />}
                        <span className="font-semibold text-sm">{gain > 0 ? '+' : ''}{gain}%</span>
                      </div>
                    </div>

                    {isExpanded && (
                      <div className="bg-gray-900 p-3 space-y-2 border-t border-gray-700">
                        <p className="text-gray-400 text-xs font-semibold mb-2">Workout History</p>
                        {allLogs.map((log, i) => (
                          <div key={i} className="flex justify-between items-center text-xs">
                            <span className="text-gray-400">{log.date} (W{log.week})</span>
                            <span className="text-white">{log.weight}{log.isCardio ? '°' : 'lbs'} × {log.reps} {log.isCardio ? 'mi' : 'reps'}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })
            )}
          </div>
        );
      };

      const renderTrends = () => {
        const sortedLogs = [...bodyweightLogs].sort((a, b) => new Date(a.date) - new Date(b.date));

        return (
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-white">Bodyweight Trends</h2>
            {sortedLogs.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No bodyweight data yet</p>
            ) : (
              <>
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="h-48 relative">
                    <svg viewBox="0 0 300 150" className="w-full h-full">
                      {sortedLogs.map((log, i) => {
                        if (i === 0) return null;
                        const prevLog = sortedLogs[i - 1];
                        const x1 = (i - 1) * (300 / (sortedLogs.length - 1));
                        const x2 = i * (300 / (sortedLogs.length - 1));
                        const minW = Math.min(...sortedLogs.map(l => l.weight));
                        const maxW = Math.max(...sortedLogs.map(l => l.weight));
                        const range = maxW - minW || 1;
                        const y1 = 150 - ((prevLog.weight - minW) / range * 130 + 10);
                        const y2 = 150 - ((log.weight - minW) / range * 130 + 10);

                        return (
                          <line
                            key={i}
                            x1={x1}
                            y1={y1}
                            x2={x2}
                            y2={y2}
                            stroke="#3b82f6"
                            strokeWidth="2"
                          />
                        );
                      })}
                    </svg>
                  </div>
                </div>
                <div className="space-y-2">
                  {sortedLogs.reverse().map((log, i) => (
                    <div key={i} className="bg-gray-800 p-3 rounded flex justify-between text-sm">
                      <span className="text-gray-400">{log.date}</span>
                      <span className="text-white font-semibold">{log.weight} lbs</span>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        );
      };

      const renderHistory = () => (
        <div className="space-y-3">
          <h2 className="text-lg font-bold text-white">Program History</h2>
          {history.length === 0 ? (
            <p className="text-gray-400 text-center py-8">No completed programs yet.</p>
          ) : (
            history.map(item => {
              const isExpanded = expandedHistory[item.id];
              return (
                <div key={item.id} className="bg-gray-800 rounded-lg overflow-hidden">
                  <button
                    onClick={() => setExpandedHistory(prev => ({ ...prev, [item.id]: !prev[item.id] }))}
                    className="w-full p-3 flex items-center justify-between"
                  >
                    <div className="text-left">
                      <p className="text-white font-semibold text-sm">{item.programName}</p>
                      <p className="text-xs text-gray-400">{item.startDate} to {item.endDate}</p>
                    </div>
                    {isExpanded ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}
                  </button>
                  {isExpanded && (
                    <div className="bg-gray-900 p-3 space-y-2 border-t border-gray-700 text-xs text-gray-300">
                      <p>Completed days: {item.completedDays} / {item.totalDays} ({item.completionRate}%)</p>
                      <p>Program ID: {item.programId}</p>
                    </div>
                  )}
                </div>
              );
            })
          )}
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-950 text-white pb-20">
          <div className="bg-gray-900 border-b border-gray-800 p-4">
            <div className="max-w-md mx-auto flex justify-between items-center">
              <h1 className="text-xl font-bold">Workout Tracker</h1>
              <button
                onClick={() => setShowMenu(!showMenu)}
                className="p-2 hover:bg-gray-800 rounded"
              >
                <Menu size={24} />
              </button>
            </div>
          </div>

          {showMenu && (
            <div className="bg-gray-900 border-b border-gray-800">
              <div className="max-w-md mx-auto p-4 space-y-2">
                <div className="bg-gray-800 p-3 rounded-lg space-y-2">
                  <label className="text-xs text-gray-400">Program Library</label>
                  <select
                    value={activeProgramId}
                    onChange={(e) => setActiveProgramId(e.target.value)}
                    className="w-full bg-gray-900 px-3 py-2 rounded text-white text-sm"
                  >
                    {programs.map(program => (
                      <option key={program.id} value={program.id}>{program.name}</option>
                    ))}
                  </select>
                  {programLoadError && (
                    <p className="text-xs text-red-400">{programLoadError}</p>
                  )}
                  {programFileWarnings.length > 0 && (
                    <div className="text-xs text-yellow-400 space-y-1">
                      {programFileWarnings.map((warning, idx) => (
                        <p key={idx}>{warning}</p>
                      ))}
                    </div>
                  )}
                </div>
                <button
                  onClick={exportData}
                  className="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-lg text-white hover:bg-gray-700"
                >
                  <Download size={20} />
                  <span>Export Data</span>
                </button>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-lg text-white hover:bg-gray-700"
                >
                  <Upload size={20} />
                  <span>Import Data</span>
                </button>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".json"
                  onChange={importData}
                  className="hidden"
                />
              </div>
            </div>
          )}

          <div className="max-w-md mx-auto p-4">
            {tab === 'today' && renderToday()}
            {tab === 'schedule' && renderSchedule()}
            {tab === 'strength' && renderStrength()}
            {tab === 'trends' && renderTrends()}
            {tab === 'history' && renderHistory()}
          </div>

          <nav className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800">
            <div className="max-w-md mx-auto flex justify-around py-3">
              <button
                onClick={() => setTab('today')}
                className={`flex flex-col items-center gap-1 ${tab === 'today' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Dumbbell size={20} />
                <span className="text-xs">Today</span>
              </button>
              <button
                onClick={() => setTab('schedule')}
                className={`flex flex-col items-center gap-1 ${tab === 'schedule' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Calendar size={20} />
                <span className="text-xs">Schedule</span>
              </button>
              <button
                onClick={() => setTab('strength')}
                className={`flex flex-col items-center gap-1 ${tab === 'strength' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <TrendingUp size={20} />
                <span className="text-xs">Strength</span>
              </button>
              <button
                onClick={() => setTab('trends')}
                className={`flex flex-col items-center gap-1 ${tab === 'trends' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <TrendingUp size={20} />
                <span className="text-xs">Trends</span>
              </button>
              <button
                onClick={() => setTab('history')}
                className={`flex flex-col items-center gap-1 ${tab === 'history' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Calendar size={20} />
                <span className="text-xs">History</span>
              </button>
            </div>
          </nav>
        </div>
      );
    }

    ReactDOM.render(<WorkoutTracker />, document.getElementById('root'));
  </script>
</body>
</html>
