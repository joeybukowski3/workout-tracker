<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Workout Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const STORAGE_KEY = 'workoutTrackerDataV2';
    const LEGACY_KEY = 'workoutData';

    const DAILY_STRETCHES = [
      '90/90 Hip Switch',
      'Thread the Needle',
      "World's Greatest Stretch (with T-Spine Rotation)",
      'Terminal Knee Extensions (TKEs) - Standing'
    ];

    // Lucide React icons as SVG components
    const Calendar = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const TrendingUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const Dumbbell = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="m6.5 6.5 11 11"></path>
        <path d="m21 21-1-1"></path>
        <path d="m3 3 1 1"></path>
        <path d="m18 22 4-4"></path>
        <path d="m2 6 4-4"></path>
        <path d="m3 10 7-7"></path>
        <path d="m14 21 7-7"></path>
      </svg>
    );

    const Menu = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    );

    const Download = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const ChevronDown = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const ChevronUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    );

    const ArrowUp = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    );

    const parseCsv = (text) => {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (lines.length === 0) return [];
      const headers = parseCsvLine(lines[0]);
      return lines.slice(1).map(line => {
        const values = parseCsvLine(line);
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx] ?? '';
        });
        return row;
      });
    };

    const parseCsvLine = (line) => {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i += 1) {
        const char = line[i];
        if (char === '"' && line[i + 1] === '"') {
          current += '"';
          i += 1;
          continue;
        }
        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
          continue;
        }
        current += char;
      }
      result.push(current);
      return result.map(value => value.trim());
    };

    const dayNumberToName = (dayNumber) => DAYS[dayNumber - 1] || 'Unknown';

    const isDayComplete = (completionMap, week, day) => {
      return completionMap?.[week]?.[day]?.completed === true;
    };

    const markDayComplete = (completionMap, week, day, date) => {
      const updated = { ...completionMap };
      if (!updated[week]) updated[week] = {};
      updated[week][day] = { completed: true, date };
      return updated;
    };

    const getNextIncomplete = (completionMap, startWeek, startDay, durationWeeks) => {
      for (let week = startWeek; week <= durationWeeks; week += 1) {
        for (let day = week === startWeek ? startDay : 1; day <= 7; day += 1) {
          if (!isDayComplete(completionMap, week, day)) {
            return { week, day };
          }
        }
      }
      return null;
    };

    const isProgramComplete = (completionMap, durationWeeks) => {
      for (let week = 1; week <= durationWeeks; week += 1) {
        for (let day = 1; day <= 7; day += 1) {
          if (!isDayComplete(completionMap, week, day)) return false;
        }
      }
      return true;
    };

    function WorkoutTracker() {
      const [tab, setTab] = useState('today');
      const [viewWeek, setViewWeek] = useState(1);
      const [programs, setPrograms] = useState([]);
      const [programManifest, setProgramManifest] = useState(null);
      const [programBasePath, setProgramBasePath] = useState('');
      const [programWeekCache, setProgramWeekCache] = useState({});
      const [programLoadError, setProgramLoadError] = useState('');
      const [programFileWarnings, setProgramFileWarnings] = useState([]);

      const [activeProgramId, setActiveProgramId] = useState('');
      const [activeWeek, setActiveWeek] = useState(1);
      const [activeDay, setActiveDay] = useState(1);
      const [startDate, setStartDate] = useState('');
      const [lastActivityDate, setLastActivityDate] = useState('');
      const [completionMap, setCompletionMap] = useState({});
      const [programProgress, setProgramProgress] = useState({});

      const [workoutLogs, setWorkoutLogs] = useState([]);
      const [bodyweightLogs, setBodyweightLogs] = useState([]);
      const [todayWeight, setTodayWeight] = useState('');
      const [todayInputs, setTodayInputs] = useState({});
      const [expandedExercises, setExpandedExercises] = useState({});
      const [expandedHistory, setExpandedHistory] = useState({});
      const [history, setHistory] = useState([]);
      const [showMenu, setShowMenu] = useState(false);
      const [showStretches, setShowStretches] = useState(false);
      const fileInputRef = useRef(null);

      useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          setActiveProgramId(data.activeProgramId || '');
          setActiveWeek(data.activeWeek || 1);
          setActiveDay(data.activeDay || 1);
          setStartDate(data.startDate || '');
          setLastActivityDate(data.lastActivityDate || '');
          setCompletionMap(data.completionMap || {});
          setProgramProgress(data.programProgress || {});
          setWorkoutLogs(data.workoutLogs || []);
          setBodyweightLogs(data.bodyweightLogs || []);
          setHistory(data.history || []);
          setViewWeek(data.activeWeek || 1);
          return;
        }

        const legacy = localStorage.getItem(LEGACY_KEY);
        if (!legacy) return;

        try {
          const legacyData = JSON.parse(legacy);
          const migratedLogs = (legacyData.workoutLogs || []).map(log => {
            const dayNum = new Date(log.date).getDay() + 1;
            return {
              ...log,
              programId: 'newwork26',
              programName: 'New Work 2026',
              day: dayNum,
              dayName: dayNumberToName(dayNum)
            };
          });
          setActiveProgramId('newwork26');
          setActiveWeek(legacyData.currentWeek || 1);
          setActiveDay(new Date().getDay() + 1);
          setStartDate(new Date().toISOString().split('T')[0]);
          setLastActivityDate('');
          setCompletionMap({});
          setProgramProgress({});
          setWorkoutLogs(migratedLogs);
          setBodyweightLogs(legacyData.bodyweightLogs || []);
          setHistory([]);
          setViewWeek(legacyData.currentWeek || 1);
        } catch (error) {
          console.error('Failed to migrate legacy data', error);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          dataVersion: 2,
          activeProgramId,
          activeWeek,
          activeDay,
          startDate,
          lastActivityDate,
          completionMap,
          programProgress,
          workoutLogs,
          bodyweightLogs,
          history
        }));
      }, [
        activeProgramId,
        activeWeek,
        activeDay,
        startDate,
        lastActivityDate,
        completionMap,
        programProgress,
        workoutLogs,
        bodyweightLogs,
        history
      ]);

      useEffect(() => {
        const loadPrograms = async () => {
          try {
            const response = await fetch('data/programs/index.json');
            if (!response.ok) throw new Error('Program index not found');
            const data = await response.json();
            setPrograms(data.programs || []);
          } catch (error) {
            console.error(error);
            setProgramLoadError('Unable to load program library. Check data/programs/index.json.');
          }
        };
        loadPrograms();
      }, []);

      useEffect(() => {
        if (programs.length === 0) return;
        if (!activeProgramId) {
          setActiveProgramId(programs[0].id);
          return;
        }
        const exists = programs.some(program => program.id === activeProgramId);
        if (!exists) {
          setProgramLoadError(`Active program "${activeProgramId}" not found. Falling back to first program.`);
          setActiveProgramId(programs[0].id);
        }
      }, [programs, activeProgramId]);

      useEffect(() => {
        if (!activeProgramId || programs.length === 0) return;
        const selected = programs.find(program => program.id === activeProgramId);
        if (!selected) return;

        const loadProgram = async () => {
          try {
            const response = await fetch(selected.path);
            if (!response.ok) throw new Error('Program manifest not found');
            const manifest = await response.json();
            setProgramManifest(manifest);
            const basePath = selected.path.split('/').slice(0, -1).join('/');
            setProgramBasePath(basePath);
            setProgramWeekCache({});
            setProgramFileWarnings([]);
          } catch (error) {
            console.error(error);
            setProgramManifest(null);
            setProgramLoadError(`Unable to load program manifest for ${selected.name}.`);
          }
        };

        loadProgram();

        const progress = programProgress[activeProgramId];
        if (progress) {
          setActiveWeek(progress.activeWeek || 1);
          setActiveDay(progress.activeDay || 1);
          setStartDate(progress.startDate || '');
          setLastActivityDate(progress.lastActivityDate || '');
          setCompletionMap(progress.completionMap || {});
          setViewWeek(progress.activeWeek || 1);
        } else {
          const today = new Date().toISOString().split('T')[0];
          setActiveWeek(1);
          setActiveDay(1);
          setStartDate(today);
          setLastActivityDate('');
          setCompletionMap({});
          setViewWeek(1);
        }
      }, [activeProgramId, programs]);

      useEffect(() => {
        if (!activeProgramId) return;
        setProgramProgress(prev => ({
          ...prev,
          [activeProgramId]: {
            activeWeek,
            activeDay,
            startDate,
            lastActivityDate,
            completionMap
          }
        }));
      }, [activeProgramId, activeWeek, activeDay, startDate, lastActivityDate, completionMap]);

      useEffect(() => {
        const exercises = getExercisesForDay(activeWeek, activeDay);
        const defaults = {};
        exercises.forEach(ex => {
          if (!todayInputs[ex]) {
            defaults[ex] = { weight: '', reps: '10' };
          }
        });
        if (Object.keys(defaults).length > 0) {
          setTodayInputs(prev => ({ ...prev, ...defaults }));
        }
      }, [activeWeek, activeDay, programWeekCache]);

      useEffect(() => {
        if (!programManifest) return;
        ensureWeekLoaded(activeWeek);
      }, [programManifest, activeWeek]);

      useEffect(() => {
        if (!programManifest) return;
        ensureWeekLoaded(viewWeek);
      }, [programManifest, viewWeek]);

      const exportData = () => {
        const data = {
          dataVersion: 2,
          activeProgramId,
          activeWeek,
          activeDay,
          startDate,
          lastActivityDate,
          completionMap,
          programProgress,
          workoutLogs,
          bodyweightLogs,
          history,
          exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        setShowMenu(false);
        alert('Data exported successfully.');
      };

      const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (confirm('This will replace all current data. Continue?')) {
              if (data.activeProgramId || data.dataVersion === 2) {
                setActiveProgramId(data.activeProgramId || '');
                setActiveWeek(data.activeWeek || 1);
                setActiveDay(data.activeDay || 1);
                setStartDate(data.startDate || '');
                setLastActivityDate(data.lastActivityDate || '');
                setCompletionMap(data.completionMap || {});
                setProgramProgress(data.programProgress || {});
                setWorkoutLogs(data.workoutLogs || []);
                setBodyweightLogs(data.bodyweightLogs || []);
                setHistory(data.history || []);
                setViewWeek(data.activeWeek || 1);
              } else {
                const migratedLogs = (data.workoutLogs || []).map(log => {
                  const dayNum = new Date(log.date).getDay() + 1;
                  return {
                    ...log,
                    programId: 'newwork26',
                    programName: 'New Work 2026',
                    day: dayNum,
                    dayName: dayNumberToName(dayNum)
                  };
                });
                setActiveProgramId('newwork26');
                setActiveWeek(data.currentWeek || 1);
                setActiveDay(new Date().getDay() + 1);
                setStartDate(new Date().toISOString().split('T')[0]);
                setLastActivityDate('');
                setCompletionMap({});
                setProgramProgress({});
                setWorkoutLogs(migratedLogs);
                setBodyweightLogs(data.bodyweightLogs || []);
                setHistory([]);
                setViewWeek(data.currentWeek || 1);
              }
              setShowMenu(false);
              alert('Data imported successfully.');
            }
          } catch (error) {
            alert('Error importing data. Please check the file format.');
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      };

      const ensureWeekLoaded = async (week) => {
        if (!programManifest || !programBasePath) return;
        if (programWeekCache[week]) return;

        const schedule = programManifest.schedule?.[String(week)] || {};
        const warnings = [];

        const dayPromises = DAYS.map(async (dayName) => {
          const fileName = schedule[dayName];
          if (!fileName) return { dayName, exercises: [] };
          const filePath = `${programBasePath}/${fileName}`;
          try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error('Missing file');
            const text = await response.text();
            const rows = parseCsv(text);
            const exercises = rows.map(row => row.Exercise).filter(Boolean);
            return { dayName, exercises };
          } catch (error) {
            warnings.push(`Missing program file: ${fileName}`);
            return { dayName, exercises: [] };
          }
        });

        const results = await Promise.all(dayPromises);
        setProgramWeekCache(prev => ({
          ...prev,
          [week]: results.reduce((acc, entry) => {
            acc[entry.dayName] = entry.exercises;
            return acc;
          }, {})
        }));
        if (warnings.length > 0) {
          setProgramFileWarnings(prev => [...new Set([...prev, ...warnings])]);
        }
      };

      const getExercisesForDay = (week, dayNumber) => {
        const dayName = dayNumberToName(dayNumber);
        return programWeekCache?.[week]?.[dayName] || [];
      };

      const isCardioExercise = (exerciseName) => {
        const lower = exerciseName.toLowerCase();
        return lower.includes('walk') || lower.includes('bike') || lower.includes('run');
      };

      const logWorkout = () => {
        const today = new Date().toISOString().split('T')[0];
        const dayName = dayNumberToName(activeDay);
        const exercises = getExercisesForDay(activeWeek, activeDay);
        
        const logs = exercises.map(exName => {
          const isCardio = isCardioExercise(exName);
          return {
            exerciseName: exName,
            weight: parseFloat(todayInputs[exName]?.weight || 0),
            reps: isCardio ? parseFloat(todayInputs[exName]?.reps || 0) : parseInt(todayInputs[exName]?.reps || 0),
            date: today,
            week: activeWeek,
            day: activeDay,
            dayName,
            isCardio: isCardio,
            programId: activeProgramId,
            programName: programManifest?.name || activeProgramId
          };
        }).filter(log => log.weight > 0 && log.reps > 0);

        const updatedCompletion = markDayComplete(completionMap, activeWeek, activeDay, today);
        setCompletionMap(updatedCompletion);
        setLastActivityDate(today);

        if (logs.length > 0) {
          setWorkoutLogs(prev => [...prev, ...logs]);
          setTodayInputs({});
          alert('Workout logged.');
        } else {
          alert('Day marked complete.');
        }

        const duration = programManifest?.durationWeeks || 6;
        const next = getNextIncomplete(updatedCompletion, activeWeek, activeDay + 1, duration)
          || getNextIncomplete(updatedCompletion, activeWeek + 1, 1, duration);
        if (next) {
          setActiveWeek(next.week);
          setActiveDay(next.day);
          setViewWeek(next.week);
        } else if (isProgramComplete(updatedCompletion, duration)) {
          finalizeProgramCompletion(updatedCompletion, today);
        }
      };

      const logBodyweight = () => {
        const today = new Date().toISOString().split('T')[0];
        if (todayWeight && parseFloat(todayWeight) > 0) {
          setBodyweightLogs(prev => [...prev, { weight: parseFloat(todayWeight), date: today }]);
          setTodayWeight('');
          alert('Bodyweight logged.');
        }
      };

      const getLastWorkout = (exerciseName) => {
        const logs = workoutLogs.filter(log => log.exerciseName === exerciseName && log.programId === activeProgramId);
        return logs.length > 0 ? logs[logs.length - 1] : null;
      };

      const getFirstWorkout = (exerciseName) => {
        const logs = workoutLogs.filter(log => log.exerciseName === exerciseName && log.programId === activeProgramId);
        return logs.length > 0 ? logs[0] : null;
      };

      const getAllWorkouts = (exerciseName) => {
        return workoutLogs
          .filter(log => log.exerciseName === exerciseName && log.programId === activeProgramId)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
      };

      const calculateGain = (exerciseName) => {
        const first = getFirstWorkout(exerciseName);
        const last = getLastWorkout(exerciseName);
        if (!first || !last) return null;
        
        const firstVol = first.weight * first.reps;
        const lastVol = last.weight * last.reps;
        const gain = ((lastVol - firstVol) / firstVol * 100).toFixed(1);
        return { first, last, gain: parseFloat(gain) };
      };

      const getExerciseEmoji = (name) => {
        const lower = name.toLowerCase();
        if (lower.includes('walk') || lower.includes('bike')) return '🏃';
        if (lower.includes('bench') || lower.includes('press') && lower.includes('chest')) return '🏋️';
        if (lower.includes('deadlift') || lower.includes('squat')) return '💪';
        if (lower.includes('curl')) return '💪';
        if (lower.includes('row') || lower.includes('pull')) return '🚣';
        if (lower.includes('leg') || lower.includes('calf')) return '🦵';
        if (lower.includes('shoulder') || lower.includes('delt')) return '💪';
        if (lower.includes('tricep')) return '💪';
        if (lower.includes('stretch') || lower.includes('mobility')) return '🧘';
        if (lower.includes('foam') || lower.includes('roll')) return '🧘';
        return '💪';
      };

      const toggleExpanded = (exerciseName) => {
        setExpandedExercises(prev => ({
          ...prev,
          [exerciseName]: !prev[exerciseName]
        }));
      };

      const toggleHistoryExpanded = (historyId) => {
        setExpandedHistory(prev => ({
          ...prev,
          [historyId]: !prev[historyId]
        }));
      };

      const finalizeProgramCompletion = (updatedCompletion, completionDate) => {
        const duration = programManifest?.durationWeeks || 6;
        if (!isProgramComplete(updatedCompletion, duration)) return;
        const programName = programManifest?.name || activeProgramId;
        const summaryId = `${activeProgramId}-${startDate || completionDate}`;
        const alreadyExists = history.some(item => item.id === summaryId);
        if (alreadyExists) return;

        const filteredLogs = workoutLogs.filter(log => log.programId === activeProgramId)
          .filter(log => !startDate || log.date >= startDate)
          .filter(log => log.date <= completionDate);
        const filteredBodyweight = bodyweightLogs
          .filter(log => !startDate || log.date >= startDate)
          .filter(log => log.date <= completionDate);

        const bestByExercise = {};
        filteredLogs.forEach(log => {
          const volume = log.weight * log.reps;
          if (!bestByExercise[log.exerciseName] || bestByExercise[log.exerciseName].volume < volume) {
            bestByExercise[log.exerciseName] = {
              exercise: log.exerciseName,
              bestWeight: log.weight,
              bestReps: log.reps,
              volume
            };
          }
        });
        const topLifts = Object.values(bestByExercise)
          .sort((a, b) => b.volume - a.volume)
          .slice(0, 5);

        const totalDays = duration * 7;
        let completedDays = 0;
        for (let week = 1; week <= duration; week += 1) {
          for (let day = 1; day <= 7; day += 1) {
            if (isDayComplete(updatedCompletion, week, day)) completedDays += 1;
          }
        }

        const bodyweightStart = filteredBodyweight[0]?.weight ?? null;
        const bodyweightEnd = filteredBodyweight[filteredBodyweight.length - 1]?.weight ?? null;
        let bodyweightTrend = 'No data';
        if (bodyweightStart !== null && bodyweightEnd !== null) {
          if (bodyweightEnd > bodyweightStart) bodyweightTrend = 'Up';
          if (bodyweightEnd < bodyweightStart) bodyweightTrend = 'Down';
          if (bodyweightEnd === bodyweightStart) bodyweightTrend = 'Flat';
        }

        const summary = {
          id: summaryId,
          programId: activeProgramId,
          programName,
          startDate: startDate || completionDate,
          endDate: completionDate,
          totalDays,
          completedDays,
          completionRate: Math.round((completedDays / totalDays) * 100),
          totalWorkouts: filteredLogs.length,
          topLifts,
          bodyweight: {
            start: bodyweightStart,
            end: bodyweightEnd,
            change: bodyweightStart !== null && bodyweightEnd !== null ? (bodyweightEnd - bodyweightStart).toFixed(1) : null,
            trend: bodyweightTrend
          }
        };

        setHistory(prev => [summary, ...prev]);
      };

      const resumeProgram = () => {
        const duration = programManifest?.durationWeeks || 6;
        const next = getNextIncomplete(completionMap, activeWeek, activeDay, duration)
          || getNextIncomplete(completionMap, 1, 1, duration);
        if (next) {
          setActiveWeek(next.week);
          setActiveDay(next.day);
          setViewWeek(next.week);
        } else {
          alert('Program complete. Start a new cycle to continue.');
        }
      };

      const restartProgram = () => {
        const today = new Date().toISOString().split('T')[0];
        setActiveWeek(1);
        setActiveDay(1);
        setStartDate(today);
        setLastActivityDate('');
        setCompletionMap({});
        setViewWeek(1);
      };

      const startOverAtBeginning = () => {
        setActiveWeek(1);
        setActiveDay(1);
        setViewWeek(1);
      };

      const renderToday = () => {
        const dayName = dayNumberToName(activeDay);
        const exercises = getExercisesForDay(activeWeek, activeDay);
        const isComplete = isDayComplete(completionMap, activeWeek, activeDay);

        return (
          <div className="space-y-3">
            <div className="bg-gray-800 p-3 rounded-lg space-y-2">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-xs text-gray-400">Active Program</p>
                  <p className="text-sm text-white font-semibold">{programManifest?.name || 'Loading...'}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-400">Progress</p>
                  <p className="text-sm text-white">Week {activeWeek} Day {activeDay}</p>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={resumeProgram} className="flex-1 px-3 py-2 bg-blue-600 rounded text-white text-xs">
                  Resume
                </button>
                <button onClick={restartProgram} className="flex-1 px-3 py-2 bg-gray-700 rounded text-white text-xs">
                  Restart Program
                </button>
                <button onClick={startOverAtBeginning} className="flex-1 px-3 py-2 bg-gray-700 rounded text-white text-xs">
                  Start Over at Week 1 Day 1
                </button>
              </div>
              <div className="flex justify-between text-xs text-gray-400">
                <span>Start: {startDate || 'Not set'}</span>
                <span>Last activity: {lastActivityDate || 'None'}</span>
              </div>
            </div>

            <div className="bg-gray-800 p-3 rounded-lg">
              <h3 className="text-sm text-gray-400 mb-2">Bodyweight Today</h3>
              <div className="flex gap-2">
                <input
                  type="number"
                  step="0.1"
                  value={todayWeight}
                  onChange={(e) => setTodayWeight(e.target.value)}
                  placeholder="Enter weight (lbs)"
                  className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                />
                <button onClick={logBodyweight} className="px-4 py-2 bg-green-600 rounded text-white text-sm">
                  Log
                </button>
              </div>
            </div>

            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">{dayName} - Week {activeWeek}</h2>
              {isComplete && (
                <span className="text-xs text-green-400">Completed</span>
              )}
            </div>

            {exercises.length === 0 ? (
              <div className="text-center py-12 text-gray-400 space-y-3">
                <p>No workout scheduled for {dayName}</p>
                <button
                  onClick={logWorkout}
                  className="px-4 py-2 bg-green-600 rounded text-white text-sm"
                >
                  Mark Day Complete
                </button>
              </div>
            ) : (
              <>
                {exercises.map((exName, idx) => {
                  const last = getLastWorkout(exName);
                  const isCardio = isCardioExercise(exName);
                  
                  return (
                    <div key={idx} className="bg-gray-800 p-3 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xl">{getExerciseEmoji(exName)}</span>
                        <div className="flex-1">
                          <h3 className="text-white font-medium text-sm">{exName}</h3>
                          {last && (
                            <p className="text-xs text-gray-400">
                              Last: {last.weight}{isCardio ? '°' : 'lbs'} × {last.reps} {isCardio ? 'mi' : 'reps'}
                            </p>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <input
                          type="number"
                          placeholder={isCardio ? "Incline" : "Weight"}
                          value={todayInputs[exName]?.weight || ''}
                          onChange={(e) => setTodayInputs(prev => ({
                            ...prev,
                            [exName]: { ...prev[exName], weight: e.target.value }
                          }))}
                          className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                        />
                        {isCardio ? (
                          <input
                            type="number"
                            step="0.1"
                            placeholder="Distance"
                            value={todayInputs[exName]?.reps || ''}
                            onChange={(e) => setTodayInputs(prev => ({
                              ...prev,
                              [exName]: { ...prev[exName], reps: e.target.value }
                            }))}
                            className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                          />
                        ) : (
                          <select
                            value={todayInputs[exName]?.reps || '10'}
                            onChange={(e) => setTodayInputs(prev => ({
                              ...prev,
                              [exName]: { ...prev[exName], reps: e.target.value }
                            }))}
                            className="flex-1 bg-gray-900 px-3 py-2 rounded text-white text-sm"
                          >
                            {[...Array(40)].map((_, i) => (
                              <option key={i + 1} value={i + 1}>{i + 1}</option>
                            ))}
                          </select>
                        )}
                      </div>
                    </div>
                  );
                })}
                <button 
                  onClick={logWorkout}
                  className="w-full py-3 bg-green-600 rounded-lg text-white font-semibold"
                >
                  Complete Workout
                </button>

                {/* Daily Stretches */}
                <div className="bg-gray-800 rounded-lg overflow-hidden">
                  <button
                    onClick={() => setShowStretches(!showStretches)}
                    className="w-full p-3 flex justify-between items-center"
                  >
                    <h3 className="text-white font-semibold text-sm">Daily Stretches</h3>
                    {showStretches ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}
                  </button>
                  {showStretches && (
                    <div className="px-3 pb-3 space-y-2">
                      {DAILY_STRETCHES.map((stretch, idx) => (
                        <div key={idx} className="flex items-start gap-2">
                          <span className="text-gray-400 text-xs mt-0.5">{idx + 1}.</span>
                          <span className="text-gray-300 text-xs">{stretch}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        );
      };

      const renderSchedule = () => {
        const schedule = programWeekCache[viewWeek] || {};
        const duration = programManifest?.durationWeeks || 6;
        
        return (
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <h2 className="text-lg font-bold text-white">Week {viewWeek} Schedule</h2>
              <div className="flex gap-2">
                {Array.from({ length: duration }, (_, i) => i + 1).map(week => (
                  <button
                    key={week}
                    onClick={() => setViewWeek(week)}
                    className={`px-3 py-1 rounded text-sm ${viewWeek === week ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'}`}
                  >
                    Week {week}
                  </button>
                ))}
              </div>
            </div>
            
            {DAYS.map(day => (
              <div key={day} className="bg-gray-800 p-3 rounded-lg">
                <h3 className="text-white font-semibold mb-2 text-sm">{day}</h3>
                {(schedule[day] || []).length === 0 ? (
                  <p className="text-gray-400 text-sm">Rest Day</p>
                ) : (
                  <div className="space-y-1">
                    {(schedule[day] || []).map((exName, idx) => (
                      <div key={idx} className="text-gray-300 text-xs">
                        {getExerciseEmoji(exName)} {exName}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      };

      const renderStrength = () => {
        const exercisesWithData = [...new Set(workoutLogs
          .filter(log => log.programId === activeProgramId)
          .map(log => log.exerciseName))];
        
        return (
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-white">Strength Progress</h2>
            {exercisesWithData.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No workout data yet. Start logging!</p>
            ) : (
              exercisesWithData.map((exName, idx) => {
                const progress = calculateGain(exName);
                const allLogs = getAllWorkouts(exName);
                const isExpanded = expandedExercises[exName];
                
                if (!progress) return null;
                
                const { first, last, gain } = progress;
                const isCardio = isCardioExercise(exName);
                
                return (
                  <div key={idx} className="bg-gray-800 rounded-lg overflow-hidden">
                    <div className="p-3">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-xl">{getExerciseEmoji(exName)}</span>
                        <h3 className="text-white font-medium text-sm flex-1">{exName}</h3>
                        <button
                          onClick={() => toggleExpanded(exName)}
                          className="text-gray-400"
                        >
                          {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-3 text-xs">
                        <div>
                          <p className="text-gray-400 mb-1">Baseline</p>
                          <p className="text-white">{first.weight}{isCardio ? '°' : 'lbs'} × {first.reps} {isCardio ? 'mi' : 'reps'}</p>
                        </div>
                        <div>
                          <p className="text-gray-400 mb-1">Current</p>
                          <p className="text-white">{last.weight}{isCardio ? '°' : 'lbs'} × {last.reps} {isCardio ? 'mi' : 'reps'}</p>
                        </div>
                      </div>
                      <div className={`mt-2 flex items-center gap-2 ${gain > 0 ? 'text-green-400' : gain < 0 ? 'text-red-400' : 'text-gray-400'}`}>
                        {gain > 0 && <ArrowUp size={14} />}
                        <span className="font-semibold text-sm">{gain > 0 ? '+' : ''}{gain}%</span>
                      </div>
                    </div>
                    
                    {isExpanded && (
                      <div className="bg-gray-900 p-3 space-y-2 border-t border-gray-700">
                        <p className="text-gray-400 text-xs font-semibold mb-2">Workout History</p>
                        {allLogs.map((log, i) => (
                          <div key={i} className="flex justify-between items-center text-xs">
                            <span className="text-gray-400">{log.date} (W{log.week} D{log.day})</span>
                            <span className="text-white">{log.weight}{log.isCardio ? '°' : 'lbs'} × {log.reps} {log.isCardio ? 'mi' : 'reps'}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })
            )}
          </div>
        );
      };

      const renderTrends = () => {
        const sortedLogs = [...bodyweightLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        return (
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-white">Bodyweight Trends</h2>
            {sortedLogs.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No bodyweight data yet</p>
            ) : (
              <>
                <div className="bg-gray-800 p-4 rounded-lg">
                  <div className="h-48 relative">
                    <svg viewBox="0 0 300 150" className="w-full h-full">
                      {sortedLogs.map((log, i) => {
                        if (i === 0) return null;
                        const prevLog = sortedLogs[i - 1];
                        const x1 = (i - 1) * (300 / (sortedLogs.length - 1));
                        const x2 = i * (300 / (sortedLogs.length - 1));
                        const minW = Math.min(...sortedLogs.map(l => l.weight));
                        const maxW = Math.max(...sortedLogs.map(l => l.weight));
                        const range = maxW - minW || 1;
                        const y1 = 150 - ((prevLog.weight - minW) / range * 130 + 10);
                        const y2 = 150 - ((log.weight - minW) / range * 130 + 10);
                        
                        return (
                          <line
                            key={i}
                            x1={x1}
                            y1={y1}
                            x2={x2}
                            y2={y2}
                            stroke="#3b82f6"
                            strokeWidth="2"
                          />
                        );
                      })}
                    </svg>
                  </div>
                </div>
                <div className="space-y-2">
                  {sortedLogs.reverse().map((log, i) => (
                    <div key={i} className="bg-gray-800 p-3 rounded flex justify-between text-sm">
                      <span className="text-gray-400">{log.date}</span>
                      <span className="text-white font-semibold">{log.weight} lbs</span>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        );
      };

      const renderHistory = () => {
        return (
          <div className="space-y-3">
            <h2 className="text-lg font-bold text-white">Program History</h2>
            {history.length === 0 ? (
              <p className="text-gray-400 text-center py-8">No completed programs yet.</p>
            ) : (
              history.map(item => {
                const isExpanded = expandedHistory[item.id];
                return (
                  <div key={item.id} className="bg-gray-800 rounded-lg overflow-hidden">
                    <button
                      onClick={() => toggleHistoryExpanded(item.id)}
                      className="w-full p-3 flex items-center justify-between"
                    >
                      <div className="text-left">
                        <p className="text-white font-semibold text-sm">{item.programName}</p>
                        <p className="text-xs text-gray-400">{item.startDate} to {item.endDate}</p>
                      </div>
                      {isExpanded ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}
                    </button>
                    {isExpanded && (
                      <div className="bg-gray-900 p-3 space-y-3 border-t border-gray-700">
                        <div className="text-xs text-gray-300 space-y-1">
                          <p>Completed days: {item.completedDays} / {item.totalDays} ({item.completionRate}%)</p>
                          <p>Total workouts logged: {item.totalWorkouts}</p>
                        </div>
                        <div className="text-xs text-gray-300 space-y-1">
                          <p className="text-gray-400 font-semibold">Top Lifts</p>
                          {item.topLifts.length === 0 ? (
                            <p>No lift data.</p>
                          ) : (
                            item.topLifts.map((lift, idx) => (
                              <p key={idx}>{lift.exercise}: {lift.bestWeight} x {lift.bestReps}</p>
                            ))
                          )}
                        </div>
                        <div className="text-xs text-gray-300 space-y-1">
                          <p className="text-gray-400 font-semibold">Bodyweight Trend</p>
                          {item.bodyweight.start === null ? (
                            <p>No bodyweight logs in range.</p>
                          ) : (
                            <p>{item.bodyweight.start} lbs to {item.bodyweight.end} lbs ({item.bodyweight.change} lbs, {item.bodyweight.trend})</p>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                );
              })
            )}
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-gray-950 text-white pb-20">
          {/* Header with Menu */}
          <div className="bg-gray-900 border-b border-gray-800 p-4">
            <div className="max-w-md mx-auto flex justify-between items-center">
              <h1 className="text-xl font-bold">Workout Tracker</h1>
              <button
                onClick={() => setShowMenu(!showMenu)}
                className="p-2 hover:bg-gray-800 rounded"
              >
                <Menu size={24} />
              </button>
            </div>
          </div>

          {/* Dropdown Menu */}
          {showMenu && (
            <div className="bg-gray-900 border-b border-gray-800">
              <div className="max-w-md mx-auto p-4 space-y-2">
                <div className="bg-gray-800 p-3 rounded-lg space-y-2">
                  <label className="text-xs text-gray-400">Program Library</label>
                  <select
                    value={activeProgramId}
                    onChange={(e) => setActiveProgramId(e.target.value)}
                    className="w-full bg-gray-900 px-3 py-2 rounded text-white text-sm"
                  >
                    {programs.map(program => (
                      <option key={program.id} value={program.id}>{program.name}</option>
                    ))}
                  </select>
                  {programLoadError && (
                    <p className="text-xs text-red-400">{programLoadError}</p>
                  )}
                  {programFileWarnings.length > 0 && (
                    <div className="text-xs text-yellow-400 space-y-1">
                      {programFileWarnings.map((warning, idx) => (
                        <p key={idx}>{warning}</p>
                      ))}
                    </div>
                  )}
                </div>
                <button
                  onClick={exportData}
                  className="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-lg text-white hover:bg-gray-700"
                >
                  <Download size={20} />
                  <span>Export Data</span>
                </button>
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full flex items-center gap-3 px-4 py-3 bg-gray-800 rounded-lg text-white hover:bg-gray-700"
                >
                  <Upload size={20} />
                  <span>Import Data</span>
                </button>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".json"
                  onChange={importData}
                  className="hidden"
                />
              </div>
            </div>
          )}

          <div className="max-w-md mx-auto p-4">
            {tab === 'today' && renderToday()}
            {tab === 'schedule' && renderSchedule()}
            {tab === 'strength' && renderStrength()}
            {tab === 'trends' && renderTrends()}
            {tab === 'history' && renderHistory()}
          </div>

          <nav className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800">
            <div className="max-w-md mx-auto flex justify-around py-3">
              <button
                onClick={() => setTab('today')}
                className={`flex flex-col items-center gap-1 ${tab === 'today' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Dumbbell size={20} />
                <span className="text-xs">Today</span>
              </button>
              <button
                onClick={() => setTab('schedule')}
                className={`flex flex-col items-center gap-1 ${tab === 'schedule' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Calendar size={20} />
                <span className="text-xs">Schedule</span>
              </button>
              <button
                onClick={() => setTab('strength')}
                className={`flex flex-col items-center gap-1 ${tab === 'strength' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <TrendingUp size={20} />
                <span className="text-xs">Strength</span>
              </button>
              <button
                onClick={() => setTab('trends')}
                className={`flex flex-col items-center gap-1 ${tab === 'trends' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <TrendingUp size={20} />
                <span className="text-xs">Trends</span>
              </button>
              <button
                onClick={() => setTab('history')}
                className={`flex flex-col items-center gap-1 ${tab === 'history' ? 'text-blue-400' : 'text-gray-400'}`}
              >
                <Calendar size={20} />
                <span className="text-xs">History</span>
              </button>
            </div>
          </nav>
        </div>
      );
    }

    ReactDOM.render(<WorkoutTracker />, document.getElementById('root'));
  </script>
</body>
</html>
